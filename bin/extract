#!/usr/bin/env ruby

require 'rubygems'
require 'bundler/setup'
$:.unshift File.expand_path(File.join(__dir__, '..', 'lib'))

require 'json'
require 'fileutils'
require 'yaz0'

root = File.expand_path(File.join(__dir__, '..'))
src = File.join(root, 'roms', 'OoT.z64')
dst = File.join(root, 'build', 'oot')

data = File.binread(src)
file_data = JSON.parse(File.read(File.join(root, 'data', 'oot.json'))).freeze

file_data.each do |f|
  path = f["path"]
  vstart = f["vstart"]
  vend = f["vend"]
  pstart = f["pstart"]
  pend = f["pend"]

  vlen = vend - vstart
  if pend.zero?
    plen = vlen
  else
    plen = pend - pstart
  end

  d = data[pstart, plen]
  p = File.join(dst, path)
  FileUtils.mkdir_p(File.dirname(p))
  if f["compressed"]
    puts "Extracting #{p}.yaz0"
    File.binwrite("#{p}.yaz0", d)
    d = Yaz0.decompress(d)
  end
  puts "Extracting #{p}"
  File.binwrite("#{p}", d)
  if f["compressed"]
    FileUtils.touch("#{p}.yaz0", nocreate: true)
  end
end
